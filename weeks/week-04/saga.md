# Диаграмма Saga (project_code: users-s07)

## Бизнес-процесс (Saga)
Пример для распределённой операции (оркестрация):

1) **Создать заказ** → статус `NEW`
2) **Зарезервировать ресурс/товар** (локальная транзакция сервиса склада/ресурсов)
3) **Списать деньги** (локальная транзакция платежного сервиса)
   - если успешно → событие `PAY_OK`, статус заказа `PAID`
   - если ошибка → событие `PAY_FAIL`, запускаем компенсацию и статус `CANCELLED`
4) **Завершить** (например, отгрузка/выдача/активация) → статус `DONE`

## Состояния заказа
- `NEW` — создан
- `PAID` — оплачен
- `DONE` — завершён
- `CANCELLED` — отменён

## Компенсация (если оплата не прошла)
Если на шаге оплаты произошла ошибка (`PAY_FAIL`):
1) Выполнить компенсирующую транзакцию: **отменить резерв** (вернуть товар/ресурс).
2) Перевести заказ в статус `CANCELLED`.

### Retry на компенсации
Если отмена резерва не удалась — повторять попытку (retry) до успеха:
- повторять через короткую задержку (например, 1s, 2s, 5s…),
- пока сервис склада/ресурсов не подтвердит отмену резерва.

## Диаграмма переходов статусов (FSM)

```text
NEW --PAY_OK--> PAID --COMPLETE--> DONE
NEW --PAY_FAIL--> CANCELLED
PAID --CANCEL--> CANCELLED
