# Saga (project_code: users-s07)

## Шаги бизнес-процесса (оркестрация)
1) **Создать заказ** → статус `NEW`
2) **Зарезервировать товар/ресурс** (Inventory Service)
3) **Списать деньги** (Payment Service)
   - если успешно → событие `PAY_OK` → статус `PAID`
   - если ошибка → событие `PAY_FAIL` → запускаем компенсацию и переводим заказ в `CANCELLED`
4) **Завершить заказ** (например, выдача/отгрузка/активация) → событие `COMPLETE` → статус `DONE`

## Состояния заказа
- `NEW` — создан
- `PAID` — оплачен
- `DONE` — завершён
- `CANCELLED` — отменён

## Компенсация
Если на шаге **оплаты** произошла ошибка:
1) Выполнить компенсирующую транзакцию: **отменить резерв** (вернуть товар/ресурс на склад).
2) Перевести заказ в статус `CANCELLED`.

### Retry на компенсации
Если отмена резерва не удалась — повторять попытку (retry) **пока не получится**.
Обычно это делают с задержкой между попытками (например, экспоненциальный backoff).

## Диаграмма переходов статусов (FSM)

```text
NEW  --PAY_OK-->   PAID  --COMPLETE-->  DONE
NEW  --PAY_FAIL--> CANCELLED

(финальные состояния: DONE, CANCELLED)
